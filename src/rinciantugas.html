<html>
    <head>
        <title> Next | Task Detail </title>
        <link rel="stylesheet" href="css/css.css">
        <link rel="stylesheet" href="css/buattask.css">
        <script>
            function submit_comment(form) {
				if (window.XMLHttpRequest){
					xmlhttp = new XMLHttpRequest();				
				} else {
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");	
				}
				
				xmlhttp.onreadystatechange = function(){
                    if (xmlhttp.readyState==4 && xmlhttp.status==200)	{
                        var s = xmlhttp.responseText;
                        var n = s.indexOf("\n");
                        
						if (n!=-1) {
							//Masukin hasilnya ke dalam div komen
                            var daftar_komentar = document.getElementById("komen");
                            
                            var username = s.substring(0,n);
                            s = s.substring(n+1);
                            n = s.indexOf("\n");
                            
                            var tanggal = s.substring(0,n);
                            s = s.substring(n+1);
                            n = s.indexOf("\n");

                            var komentar = unescape(s.substring(0,n));
                            s = s.substring(n+1);
                            n = s.indexOf("\n");                            
                            
                            var tambah = '<div id = "daftarkomen">'
                            tambah += username + " " + tanggal + "<br>";
                            tambah += komentar;
                            tambah += "</div>";
                            var n = daftar_komentar.innerHTML.indexOf("<form name=\"form_comment\">");
                            daftar_komentar.innerHTML = daftar_komentar.innerHTML.substring(0,n) + tambah
                                                      + daftar_komentar.innerHTML.substring(n);
						} else {
							alert("Gagal memposting komentar");
						}						
					}
				}

                id_tugas = "-1";
                if ((c = window.location.search.indexOf("id_tugas=")) != -1) {
                    id_tugas = window.location.search.substring(c+9);
                } 

                params = "komentar="+escape(form.comment.value)+"&user="+localStorage.userLogin+"&id_tugas="+id_tugas;
				xmlhttp.open("POST","tambah_komentar.php",true);                
                xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				xmlhttp.send(params);
            }
        
            function take_data() {
                if (window.XMLHttpRequest) {
                    xmlhttp1 = new XMLHttpRequest();
                    xmlhttp2 = new XMLHttpRequest();
                } else {
                    xmlhttp1 = new ActiveXObject("Microsoft.XMLHTTP");
                    xmlhttp2 = new ActiveXObject("Microsoft.XMLHTTP");
                }
                
                xmlhttp1.onreadystatechange = function() {
                    if (xmlhttp1.readyState == 4 && xmlhttp1.status == 200) {
                        var s = xmlhttp1.responseText;
                        var n = s.indexOf("\n");
                        //alert(s);
                        
                        if (n != -1) {
                            //Ambil data-data tugas
                            var nama_tugas = s.substring(0,n);
                            s = s.substring(n+1);
                            n = s.indexOf("\n");
                            
                            var tanggal = s.substring(0,n);
                            s = s.substring(n+1);
                            n = s.indexOf("\n");

                            var status = s.substring(0,n);
                            s = s.substring(n+1);
                            n = s.indexOf("\n");

                            var tag = unescape(s.substring(0,n));
                            s = s.substring(n+1);
                            n = s.indexOf("\n")
 
                            var attachment = unescape(s.substring(0,n));
                            s = s.substring(n+1);
                            n = s.indexOf("\n");
                            
                            //Tampilkan datanya
                            document.getElementById("judultugas").innerHTML = nama_tugas;
                            
                            var detail = document.getElementById("detail");
                            
                            var tambah2 = '<form>'
                            var tambah = "<label>STATUS TUGAS</label>";
                            if (status == 1) tambah += '<a id="status">DONE</a>';
                            else tambah += '<a id="status">IN THE PROCESS</a>';
                            
                            tambah2 += '<label>STATUS TUGAS</label>';
                            if (status == 1) tambah2 += '<input type="checkbox" name="status" value="done" checked>';
                            else tambah2 += '<input type="checkbox" name="status" value="done">';
                            
                            tambah += '<label>DEADLINE</label>';
                            tambah += '<a id="deadline">'+tanggal+"</a>";
                            
                            tambah2 += '<label>DEADLINE</label>';
                            tambah2 += '<a id="deadline">'+tanggal+"</a>";
                            
                            var orang = "";
                            tambah += "<label>ASSIGNEE</label>";
                            tambah += '<a id="assignee">';
                            while (n != -1) {
                                tambah += unescape(s.substring(0,n)) + "<br>";
                                orang += unescape(s.substring(0,n))+"/";
                                s = s.substring(n+1);
                                n = s.indexOf("\n");
                            }
                            tambah += '</a>';

                            tambah2 += '<input type="textarea" name="assignee" placeholder="assignee" value="'+orang+'">';
                            
                            tambah += "<label>TAG</label>";
                            tambah += '<a id="tag">'+tag+'</a>';

                            tambah2 += "<label>TAG</label>";
                            tambah2 += '<input type="textarea" name="catname" placeholder="tag" value="'+tag+'">';
                            
                            tambah += "<label>ATTACHMENT</label>";
                            tambah += '<a href ="#" id="attach">Download Here</a>'; 
                            
                            tambah2 += "<label>ATTACHMENT</label>";
                            tambah2 += '<a href ="#" id="attach">Download Here</a>'; 
                            tambah2 += '</br><input class= "submitreg" name="submit" type="button" value="Submit"';
                            tambah2 += 'onclick="hideEdit(),submit_edit(this.form)"></form>'; 
                            
                            detail.innerHTML = tambah;
                            document.getElementById("detailedit").innerHTML=tambah2;
                        } else {
                            alert(xmlhttp1.responseText);
                        }                        
                    }
                }
                
                xmlhttp2.onreadystatechange = function() {
                    if (xmlhttp2.readyState == 4 && xmlhttp2.status == 200) {
                        var s = xmlhttp2.responseText;
                        var n = s.indexOf("\n");
                        daftar_komentar = document.getElementById("komen");
                        daftar_komentar.innerHTML = "";
                        //alert(daftar_komentar.innerHTML);
                        
                        while (n != -1) {
                            //Ambil satu data komentar
                            var username = s.substring(0,n);
                            s = s.substring(n+1);
                            n = s.indexOf("\n");
                            
                            var tanggal = s.substring(0,n);
                            s = s.substring(n+1);
                            n = s.indexOf("\n");

                            var komentar = unescape(s.substring(0,n));
                            s = s.substring(n+1);
                            n = s.indexOf("\n");
 
                            //Tampilkan datanya
                            var tambah = '<div id = "daftarkomen">'
                            tambah += username + " " + tanggal + "<br>";
                            tambah += komentar;
                            tambah += "</div>";
                            daftar_komentar.innerHTML += tambah+"\n";                         
                        }
                    }
                    
                    if (xmlhttp2.readyState == 4) {
                        daftar_komentar = document.getElementById("komen");
                        daftar_komentar.innerHTML += '<form name="form_comment">\n'
                                                   + '<div id="submitkomen">\n'
                                                   + '<label>submit comment</label>\n'
                                                   + '<textarea name="comment" type="comment" placeholder="comment" class="isikomen"></textarea>\n'
                                                   + '<input class= "submitreg" name="submit" type="button" onclick="submit_comment(this.form)" value="Submit">\n'
                                                   + '</div>\n'
                                                   + '</form>\n';                    
                    }
                }
                
                //Untuk mengambil data tugas
                id_tugas = "-1";
                if ((c = window.location.search.indexOf("id_tugas=")) != -1) {
                    id_tugas = window.location.search.substring(c+9);
                } 
                xmlhttp1.open("GET","ambil_detail_tugas.php?id_tugas="+id_tugas,true);
                xmlhttp1.send();
                
                //Untuk mengambil daftar komentar awal
                params = "id_tugas="+"1";
                xmlhttp2.open("POST","ambil_komentar.php",true);
                xmlhttp2.setRequestHeader("Content-type","application/x-www-form-urlencoded");
                xmlhttp2.send(params);
            }
        
            function showEdit(){
                document.getElementById("detailedit").style.visibility="visible";
                document.getElementById("detail").style.visibility="hidden";
            }
            function hideEdit(){
                document.getElementById("detailedit").style.visibility="hidden";
                document.getElementById("detail").style.visibility="visible";
            }
            
            function submit_edit(form) {
				if (window.XMLHttpRequest){
					xmlhttp = new XMLHttpRequest();				
				} else {
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");	
				}
				
				xmlhttp.onreadystatechange = function(){
                    if (xmlhttp.readyState==4)	{
                        //alert(xmlhttp.responseText);
                        take_data();
					}
				}
				
                params = "assignee="+escape(form.assignee.value)+"&tag="+escape(form.catname.value)+"&id_tugas="+id_tugas+"&status=";
                if (form.status.checked) params += "1";
                else params += "0";
                //alert(params);
				xmlhttp.open("POST","edit_detail_tugas.php",true);
                xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				xmlhttp.send(params);                
            }
        </script>
    </head>
    <body onload="take_data()">
        <div class="header">
            <div id="logo">
                <a hreg="dashboard.html">
                <img src="pict/logo.png">
                </a>
            </div>
            <div id="border">
                
            </div>
            <div id="dashboard">
                <a href="dashboard.html">DASHBOARD</a>
            </div>
            <div id="profile">
                <a href="profile.html">PROFILE</a>
            </div>
            <div id="search">
				<section class="searchform cf">
					<input class="searchbox" type="search" name="search" placeholder="Search.." required>
					
				</section>
				<section class="searchbuttonbox cf">
					<img class="searchbutton"src="pict/search button.jpg">
				</section>
				
			</div>
            <div id="wellfaiz">
                
            </div>
            <div id="logout">
                <a href="index.html">LOGOUT</a>
            </div>
        </div>
        <div class="main">
            <div id="edit" onclick="showEdit()">
            </div>
            <a href="dashboard.html">
                <div id="back">
                </div>
            </a>
            <div id="rinciantugas">
                <div id="judultugas"></div>
                <div id="detail" style="visibility: visible">
                                        
                </div>
                <div id="detailedit" style="visibility: hidden">
        
                </div>
            </div>
            <div id="komen">

            </div>
        </div>
        <div class="footer">
            Copyright © Christianto Handojo - Johannes Ridho - Ahmad Faiz - Fandi Pradana - Sigit Aji
        </div>
        
    </body>
</html>